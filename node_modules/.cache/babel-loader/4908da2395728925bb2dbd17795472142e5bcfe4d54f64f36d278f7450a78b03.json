{"ast":null,"code":"import { createAsyncThunk, createSlice } from '@reduxjs/toolkit';\nimport { login } from './loginAPI';\nimport { jwtDecode } from \"jwt-decode\";\nconst initialState = {\n  username: '',\n  password: '',\n  status: 'idle',\n  token: '',\n  logged: false,\n  userfirstName: undefined,\n  userlastName: undefined\n};\n\n// Add a new async thunk to check sessionStorage for the token\nexport const checkSessionToken = createAsyncThunk('login/checkSessionToken', async () => {\n  const storedToken = sessionStorage.getItem('token');\n  if (storedToken) {\n    return storedToken;\n  }\n  throw new Error('No stored token');\n});\nexport const loginAsync = createAsyncThunk('login/login', async (credentials, {\n  dispatch\n}) => {\n  try {\n    // Check for the session token first\n    const sessionToken = await dispatch(checkSessionToken());\n\n    // If session token is available, use it\n    const decodedSessionToken = jwtDecode(sessionToken);\n    return {\n      access: sessionToken,\n      first_name: decodedSessionToken.first_name,\n      last_name: decodedSessionToken.last_name\n    };\n  } catch (error) {\n    // If no session token, make a new request to the server\n    const response = await login(credentials);\n    return response.data;\n  }\n});\nexport const loginSlice = createSlice({\n  name: 'login',\n  initialState,\n  reducers: {\n    loginFulfilled: (state, action) => {\n      state.token = action.payload.access;\n      state.logged = true;\n      state.status = 'loading';\n      state.userfirstName = action.payload.first_name;\n      state.userlastName = action.payload.last_name;\n\n      // Store the token and additional data in sessionStorage\n      sessionStorage.setItem('token', JSON.stringify(state.token));\n      sessionStorage.setItem('firstName', JSON.stringify(state.userfirstName));\n      sessionStorage.setItem('lastName', JSON.stringify(state.userlastName));\n    }\n  },\n  extraReducers: builder => {\n    builder.addCase(loginAsync.fulfilled, (state, action) => {\n      // Assuming your server response includes custom claims like 'first_name' and 'last_name'\n      loginSlice.caseReducers.loginFulfilled(state, action);\n    }).addCase(loginAsync.rejected, (state, action) => {\n      // Assuming you have an API call rejection for an expired token scenario\n      if (action.error.message === 'Token expired') {\n        state.token = ''; // Clear the expired token\n        state.logged = false; // Set logged to false\n        state.status = 'idle';\n        state.userfirstName = undefined; // Clear the additional data\n        state.userlastName = undefined;\n        sessionStorage.removeItem('token'); // Remove the token from sessionStorage\n        sessionStorage.removeItem('firstName');\n        sessionStorage.removeItem('lastName');\n      }\n    });\n  }\n});\nexport const selectstatus = state => state.login.status;\nexport const selectLogged = state => state.login.logged;\nexport const selectToken = state => state.login.token;\nexport const selectFirstName = state => state.login.userfirstName;\nexport const selectLastName = state => state.login.userlastName;\nexport default loginSlice.reducer;","map":{"version":3,"names":["createAsyncThunk","createSlice","login","jwtDecode","initialState","username","password","status","token","logged","userfirstName","undefined","userlastName","checkSessionToken","storedToken","sessionStorage","getItem","Error","loginAsync","credentials","dispatch","sessionToken","decodedSessionToken","access","first_name","last_name","error","response","data","loginSlice","name","reducers","loginFulfilled","state","action","payload","setItem","JSON","stringify","extraReducers","builder","addCase","fulfilled","caseReducers","rejected","message","removeItem","selectstatus","selectLogged","selectToken","selectFirstName","selectLastName","reducer"],"sources":["/Users/gilyasur/Documents/My Projects/dashBoard /Front/my-app/src/features/Presite/login/loginSlice.ts"],"sourcesContent":["import { createAsyncThunk, createSlice } from '@reduxjs/toolkit';\nimport { RootState } from '../../../app/store';\nimport { login } from './loginAPI';\nimport { jwtDecode } from \"jwt-decode\";\n\nexport interface loginState {\n  username: string;\n  password: string;\n  status: 'idle' | 'loading' | 'failed';\n  token: string;\n  logged: boolean;\n  userfirstName?: string;\n  userlastName?: string;\n}\n\nconst initialState: loginState = {\n  username: '',\n  password: '',\n  status: 'idle',\n  token: '',\n  logged: false,\n  userfirstName: undefined,\n  userlastName: undefined,\n};\n\n// Add a new async thunk to check sessionStorage for the token\nexport const checkSessionToken = createAsyncThunk(\n  'login/checkSessionToken',\n  async () => {\n    const storedToken = sessionStorage.getItem('token');\n    if (storedToken) {\n      return storedToken;\n    }\n    throw new Error('No stored token');\n  }\n);\n\nexport const loginAsync = createAsyncThunk(\n  'login/login',\n  async (credentials: { username: string; password: string }, { dispatch }) => {\n    try {\n      // Check for the session token first\n      const sessionToken:any = await dispatch(checkSessionToken());\n      \n      // If session token is available, use it\n      const decodedSessionToken: any = jwtDecode(sessionToken);\n      return {\n        access: sessionToken,\n        first_name: decodedSessionToken.first_name,\n        last_name: decodedSessionToken.last_name,\n      };\n    } catch (error) {\n      // If no session token, make a new request to the server\n      const response = await login(credentials);\n      return response.data;\n    }\n  }\n);\n\nexport const loginSlice = createSlice({\n  name: 'login',\n  initialState,\n  reducers: {\n    loginFulfilled: (state, action) => {\n      state.token = action.payload.access;\n      state.logged = true;\n      state.status = 'loading';\n      state.userfirstName = action.payload.first_name;\n      state.userlastName = action.payload.last_name;\n\n      // Store the token and additional data in sessionStorage\n      sessionStorage.setItem('token', JSON.stringify(state.token));\n      sessionStorage.setItem('firstName', JSON.stringify(state.userfirstName));\n      sessionStorage.setItem('lastName', JSON.stringify(state.userlastName));\n    },\n  },\n  extraReducers: (builder) => {\n    builder\n      .addCase(loginAsync.fulfilled, (state, action) => {\n        // Assuming your server response includes custom claims like 'first_name' and 'last_name'\n        loginSlice.caseReducers.loginFulfilled(state, action);\n      })\n      .addCase(loginAsync.rejected, (state, action) => {\n        // Assuming you have an API call rejection for an expired token scenario\n        if (action.error.message === 'Token expired') {\n          state.token = ''; // Clear the expired token\n          state.logged = false; // Set logged to false\n          state.status = 'idle';\n          state.userfirstName = undefined; // Clear the additional data\n          state.userlastName = undefined;\n          sessionStorage.removeItem('token'); // Remove the token from sessionStorage\n          sessionStorage.removeItem('firstName');\n          sessionStorage.removeItem('lastName');\n        }\n      });\n  },\n});\n\nexport const selectstatus = (state: RootState) => state.login.status;\nexport const selectLogged = (state: RootState) => state.login.logged;\nexport const selectToken = (state: RootState) => state.login.token;\nexport const selectFirstName = (state: RootState) => state.login.userfirstName;\nexport const selectLastName = (state: RootState) => state.login.userlastName;\n\nexport default loginSlice.reducer;\n"],"mappings":"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"},"metadata":{},"sourceType":"module","externalDependencies":[]}